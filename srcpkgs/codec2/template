# Template file for 'codec2'
pkgname=codec2
version=1.0.3
revision=1
build_style=cmake
checkdepends="gcc-fortran git gnuplot libgomp-devel octave openblas-devel python3-numpy sox tar valgrind"
short_desc="Low bit rate speech codec"
maintainer="Evgeny Ermakov <evgeny.v.ermakov@gmail.com>"
license="LGPL-2.1-only"
homepage="https://www.rowetel.com/codec2.html"
distfiles="https://github.com/drowe67/codec2/archive/v${version}.tar.gz"
checksum=48162d562ea3bf4ca273f3c45df04505a006bd9a2b376006c75706c4de957da7

if [ "$XBPS_CHECK_PKGS" ]; then
	configure_args+=" -DUNITTEST=1"
fi

post_fetch() {
	if [ "$XBPS_CHECK_PKGS" ]; then
		octave-cli --eval "pkg install -verbose -forge control signal"
	fi
}

do_check() {
	cd build
	ctest -E "test_codec2_700c_octave_port|\
test_freedv_api_700D_burble|\
test_freedv_data_raw_fsk_ldpc_100|\
test_ldpc_enc_dec_HRA_56_56|\
test_ldpc_enc_dec_H_16200_9720|\
test_ldpc_enc_dec_H_2064_516_sparse|\
test_vq_mbest"
}

codec2-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.so"
	}
}
